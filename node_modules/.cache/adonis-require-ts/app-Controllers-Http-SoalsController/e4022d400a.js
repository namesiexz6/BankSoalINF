"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Application_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Application"));
const Soal_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Soal"));
const Matakuliah_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Matakuliah"));
const KomentarSoal_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/KomentarSoal"));
class SoalsController {
    async index({ view }) {
        const matakuliah = await Matakuliah_1.default.all();
        return view.render("auth/uploadSoal", { matakuliah });
    }
    async store({ request, response, session }) {
        const isi_soal = request.file("formFile");
        const semester = request.input("semester");
        const id_mk = request.input("mk");
        const nama_soal = request.input("namasoal");
        const nama = session.get("nama");
        session.put("semester", semester);
        if (!nama_soal) {
            return response.redirect("/uploadSoal");
        }
        if (!isi_soal) {
            return response.redirect("/uploadSoal");
        }
        await isi_soal.move(Application_1.default.publicPath("uploads"));
        await Soal_1.default.create({
            nama,
            id_mk,
            nama_soal,
            isi_soal: isi_soal.fileName,
        });
        return response.redirect("/");
    }
    async show({ view, request, session }) {
        const semester = request.input("semester");
        const mk = await Matakuliah_1.default.query()
            .where("id_semester", semester)
            .orderBy("id", "asc");
        let sks = 0;
        let id = request.input("edit");
        if (id != null) {
            session.put("edit", id);
        }
        else {
            session.put("edit", 0);
        }
        mk.forEach((mk) => {
            sks += mk.sks;
        });
        session.put("id_semester", semester);
        return view.render("auth/semester", { mk, sks });
    }
    async showsoal({ view, response, request, session }) {
        let id_mk = request.input("matakuliah_id");
        const mk = await Matakuliah_1.default.query()
            .where("id", id_mk)
            .orderBy("id", "asc")
            .firstOrFail();
        const soal = await Soal_1.default.query().where("id_mk", id_mk).orderBy("id", "asc");
        let id = request.input("edit");
        if (id == 1) {
            session.put("edit", id);
            const matakuliah = await Matakuliah_1.default.all();
            return view.render("auth/uploadSoal", { matakuliah });
        }
        else if (id == 3) {
            session.put("edit", id);
        }
        else {
            session.put("edit", 0);
        }
        session.put("namamk", mk.nama);
        session.put("id_matakuliah", id_mk);
        return view.render("auth/soal", { soal });
    }
    async lihatsoal({ view, request }) {
        let id_soal = request.input("soals_id");
        const soal = await Soal_1.default.query().where("id", id_soal).orderBy("id", "asc");
        const komentar_soal = await KomentarSoal_1.default.query()
            .where("id_soal", id_soal)
            .orderBy("id", "asc");
        return view.render("auth/lihatsoal", { soal, komentar_soal });
    }
    async komentar({ response, request }) {
        let id_soal = request.input("soals_id");
        const nama = request.input("nama");
        const isi_komentar = request.input("isi_komentar");
        const hapus = request.input("hapus");
        const id = request.input("komentar_id");
        if (hapus == "1") {
            await KomentarSoal_1.default.query().where("id", id).delete();
            return response.redirect("/lihatsoal?soals_id=" + id_soal);
        }
        if (!nama) {
            return response.redirect("/lihatsoal?soals_id=" + id_soal);
        }
        if (!isi_komentar) {
            return response.redirect("/lihatsoal?soals_id=" + id_soal);
        }
        await KomentarSoal_1.default.create({ id_soal, nama_komentar: nama, isi_komentar });
        return response.redirect("/lihatsoal?soals_id=" + id_soal);
    }
    async editmatakuliah({ response, request, session }) {
        const semester = request.input("semester");
        let cancel = request.input("cancel");
        if (session.get("edit") == 1) {
            if (cancel == "2") {
                return response.redirect("/semester?semester=" + semester);
            }
            else {
                const kode_mk = request.input("kode");
                const nama_mk = request.input("nama");
                const sks = request.input("sks");
                if (!kode_mk) {
                    session.flash('error', 'Error! KodeMata Kuliah tidak boleh kosong!');
                    return response.redirect("/semester?semester=" + semester);
                }
                if (!nama_mk) {
                    session.flash('error', 'Error! Nama Mata Kuliah tidak boleh kosong!');
                    return response.redirect("/semester?semester=" + semester);
                }
                if (!sks) {
                    session.flash('error', 'Error! SKS tidak boleh kosong!');
                    return response.redirect("/semester?semester=" + semester);
                }
                await Matakuliah_1.default.create({ id_semester: semester, kode: kode_mk, nama: nama_mk, sks: sks });
                return response.redirect("/semester?semester=" + semester);
            }
        }
        else if (session.get("edit") == 3) {
            if (cancel == "2") {
                return response.redirect("/semester?semester=" + semester);
            }
            let id = request.input("hapus");
            const soal = await Soal_1.default.query().where("id_mk", id).orderBy("id", "asc");
            await KomentarSoal_1.default.query().whereIn("id_soal", soal.map(row => row.id.toString())).delete();
            await Soal_1.default.query().where("id_mk", id).delete();
            await Matakuliah_1.default.query().where("id", id).delete();
            return response.redirect("/semester?semester=" + semester);
        }
        else {
            session.put("matakuliah_id", request.input("update"));
            if (cancel == "2") {
                session.put("matakuliah_id", -1);
                return response.redirect("/semester?semester=" + semester);
            }
            else if (cancel == "3") {
                let id = request.input("update");
                const kode_mk = request.input("kode");
                const nama_mk = request.input("nama");
                const sks = request.input("sks");
                if (!kode_mk) {
                    session.flash('error', 'Error! Kode Mata Kuliah tidak boleh kosong!');
                    return response.redirect("/semester?semester=" + semester);
                }
                if (!nama_mk) {
                    session.flash('error', 'Error! Nama Mata Kuliah tidak boleh kosong!');
                    return response.redirect("/semester?semester=" + semester);
                }
                if (!sks) {
                    session.flash('error', 'Error! SKS tidak boleh kosong!');
                    return response.redirect("/semester?semester=" + semester);
                }
                await Matakuliah_1.default.query().where("id", id).update({ id_semester: semester, kode: kode_mk, nama: nama_mk, sks: sks });
                session.put("matakuliah_id", -1);
                console.log("kode_mk");
                return response.redirect("/semester?semester=" + semester);
            }
            return response.redirect("/semester?semester=" + semester + "&edit=2");
        }
    }
    async editsoal({ response, request, session }) {
        const id_matakuliah = request.input("matakuliah_id");
        let cancel = request.input("cancel");
        if (session.get("edit") == 3) {
            if (cancel == "2") {
                return response.redirect("/soal?matakuliah_id=" + id_matakuliah);
            }
            let id = request.input("hapus");
            console.log(id);
            await KomentarSoal_1.default.query().where("id_soal", id).delete();
            await Soal_1.default.query().where("id", id).delete();
            return response.redirect("/soal?matakuliah_id=" + id_matakuliah);
        }
    }
}
exports.default = SoalsController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU29hbHNDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU29hbHNDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUEsZ0dBQXVEO0FBQ3ZELGlGQUFtQztBQUNuQyw2RkFBK0M7QUFDL0MsaUdBQW9EO0FBSXBELE1BQXFCLGVBQWU7SUFDM0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksRUFBdUI7UUFDOUMsTUFBTSxVQUFVLEdBQUcsTUFBTSxvQkFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzFDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUNNLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRTtRQUMvQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzFDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDM0MsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsQyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzVDLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFbEMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE9BQU8sUUFBUSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUN6QztRQUVELElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixPQUFPLFFBQVEsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7U0FD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LENBQUMsUUFBUSxDQUFDLHFCQUFxQixHQUFHLFFBQVEsQ0FBQyxDQUFDO2FBQzVEO1lBQ0QsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDLHFCQUFxQixHQUFHLFFBQVEsR0FBRyxTQUFTLENBQUMsQ0FBQztTQUN4RTtJQUVILENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQXVCO1FBQ3ZFLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDckQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyQyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzVCLElBQUksTUFBTSxJQUFJLEdBQUcsRUFBRTtnQkFDakIsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDLHNCQUFzQixHQUFHLGFBQWEsQ0FBQyxDQUFDO2FBQ2xFO1lBQ0QsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLE1BQU0sc0JBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzFELE1BQU0sY0FBSSxDQUFDLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDNUMsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDLHNCQUFzQixHQUFHLGFBQWEsQ0FBQyxDQUFDO1NBRWxFO0lBRUgsQ0FBQztDQUNGO0FBcE1ELGtDQW9NQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gXCJAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0XCI7XG5cbmltcG9ydCBBcHBsaWNhdGlvbiBmcm9tIFwiQGlvYzpBZG9uaXMvQ29yZS9BcHBsaWNhdGlvblwiO1xuaW1wb3J0IFNvYWwgZnJvbSBcIkFwcC9Nb2RlbHMvU29hbFwiO1xuaW1wb3J0IE1hdGFrdWxpYWggZnJvbSBcIkFwcC9Nb2RlbHMvTWF0YWt1bGlhaFwiO1xuaW1wb3J0IEtvbWVudGFyX3NvYWwgZnJvbSBcIkFwcC9Nb2RlbHMvS29tZW50YXJTb2FsXCI7XG5cbmltcG9ydCBfa29tZW50YXJfc29hbHMgZnJvbSBcIkRhdGFiYXNlL21pZ3JhdGlvbnMvNl9rb21lbnRhcl9zb2Fsc1wiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTb2Fsc0NvbnRyb2xsZXIge1xuICBwdWJsaWMgYXN5bmMgaW5kZXgoeyB2aWV3IH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBtYXRha3VsaWFoID0gYXdhaXQgTWF0YWt1bGlhaC5hbGwoKTtcbiAgICByZXR1cm4gdmlldy5yZW5kZXIoXCJhdXRoL3VwbG9hZFNvYWxcIiwgeyBtYXRha3VsaWFoIH0pO1xuICB9XG4gIHB1YmxpYyBhc3luYyBzdG9yZSh7IHJlcXVlc3QsIHJlc3BvbnNlLCBzZXNzaW9uIH0pIHtcbiAgICBjb25zdCBpc2lfc29hbCA9IHJlcXVlc3QuZmlsZShcImZvcm1GaWxlXCIpO1xuICAgIGNvbnN0IHNlbWVzdGVyID0gcmVxdWVzdC5pbnB1dChcInNlbWVzdGVyXCIpO1xuICAgIGNvbnN0IGlkX21rID0gcmVxdWVzdC5pbnB1dChcIm1rXCIpO1xuICAgIGNvbnN0IG5hbWFfc29hbCA9IHJlcXVlc3QuaW5wdXQoXCJuYW1hc29hbFwiKTtcbiAgICBjb25zdCBuYW1hID0gc2Vzc2lvbi5nZXQoXCJuYW1hXCIpO1xuXG4gICAgc2Vzc2lvbi5wdXQoXCJzZW1lc3RlclwiLCBzZW1lc3Rlcik7XG5cbiAgICBpZiAoIW5hbWFfc29hbCkge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3VwbG9hZFNvYWxcIik7XG4gICAgfVxuXG4gICAgaWYgKCFpc2lfc29hbCkge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3VwbG9hZFNvYWxcIik7XG4gICAgfVxuICAgIGF3YWl0IGlzaV9zb2FsLm1vdmUoQXBwbGljYXRpb24ucHVibGljUGF0aChcInVwbG9hZHNcIikpO1xuICAgIGF3YWl0IFNvYWwuY3JlYXRlKHtcbiAgICAgIG5hbWEsXG4gICAgICBpZF9tayxcbiAgICAgIG5hbWFfc29hbCxcbiAgICAgIGlzaV9zb2FsOiBpc2lfc29hbC5maWxlTmFtZSxcbiAgICB9KTtcblxuICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdChcIi9cIik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2hvdyh7IHZpZXcsIHJlcXVlc3QsIHNlc3Npb24gfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IHNlbWVzdGVyID0gcmVxdWVzdC5pbnB1dChcInNlbWVzdGVyXCIpO1xuICAgIGNvbnN0IG1rID0gYXdhaXQgTWF0YWt1bGlhaC5xdWVyeSgpXG4gICAgICAud2hlcmUoXCJpZF9zZW1lc3RlclwiLCBzZW1lc3RlcilcbiAgICAgIC5vcmRlckJ5KFwiaWRcIiwgXCJhc2NcIik7XG4gICAgbGV0IHNrcyA9IDA7XG4gICAgbGV0IGlkID0gcmVxdWVzdC5pbnB1dChcImVkaXRcIik7XG4gICAgaWYgKGlkICE9IG51bGwpIHtcbiAgICAgIHNlc3Npb24ucHV0KFwiZWRpdFwiLCBpZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNlc3Npb24ucHV0KFwiZWRpdFwiLCAwKTtcbiAgICB9XG4gICAgbWsuZm9yRWFjaCgobWspID0+IHtcbiAgICAgIHNrcyArPSBtay5za3M7XG4gICAgfSk7XG5cbiAgICBzZXNzaW9uLnB1dChcImlkX3NlbWVzdGVyXCIsIHNlbWVzdGVyKTtcblxuICAgIHJldHVybiB2aWV3LnJlbmRlcihcImF1dGgvc2VtZXN0ZXJcIiwgeyBtaywgc2tzIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNob3dzb2FsKHsgdmlldyxyZXNwb25zZSwgcmVxdWVzdCwgc2Vzc2lvbiB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgbGV0IGlkX21rID0gcmVxdWVzdC5pbnB1dChcIm1hdGFrdWxpYWhfaWRcIik7XG4gICAgY29uc3QgbWsgPSBhd2FpdCBNYXRha3VsaWFoLnF1ZXJ5KClcbiAgICAgIC53aGVyZShcImlkXCIsIGlkX21rKVxuICAgICAgLm9yZGVyQnkoXCJpZFwiLCBcImFzY1wiKVxuICAgICAgLmZpcnN0T3JGYWlsKCk7XG4gICAgY29uc3Qgc29hbCA9IGF3YWl0IFNvYWwucXVlcnkoKS53aGVyZShcImlkX21rXCIsIGlkX21rKS5vcmRlckJ5KFwiaWRcIiwgXCJhc2NcIik7XG5cbiAgICBsZXQgaWQgPSByZXF1ZXN0LmlucHV0KFwiZWRpdFwiKTtcbiAgICBpZiAoaWQgPT0gMSkge1xuICAgICAgc2Vzc2lvbi5wdXQoXCJlZGl0XCIsIGlkKTtcbiAgICAgIGNvbnN0IG1hdGFrdWxpYWggPSBhd2FpdCBNYXRha3VsaWFoLmFsbCgpO1xuICAgICAgcmV0dXJuIHZpZXcucmVuZGVyKFwiYXV0aC91cGxvYWRTb2FsXCIsIHsgbWF0YWt1bGlhaCB9KTtcbiAgICB9ZWxzZSBpZiAoaWQgPT0gMykge1xuICAgICAgc2Vzc2lvbi5wdXQoXCJlZGl0XCIsIGlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2Vzc2lvbi5wdXQoXCJlZGl0XCIsIDApO1xuICAgIH1cblxuICAgIHNlc3Npb24ucHV0KFwibmFtYW1rXCIsIG1rLm5hbWEpO1xuICAgIHNlc3Npb24ucHV0KFwiaWRfbWF0YWt1bGlhaFwiLCBpZF9tayk7XG5cbiAgICByZXR1cm4gdmlldy5yZW5kZXIoXCJhdXRoL3NvYWxcIiwgeyBzb2FsIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpaGF0c29hbCh7IHZpZXcsIHJlcXVlc3QgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGxldCBpZF9zb2FsID0gcmVxdWVzdC5pbnB1dChcInNvYWxzX2lkXCIpO1xuICAgIGNvbnN0IHNvYWwgPSBhd2FpdCBTb2FsLnF1ZXJ5KCkud2hlcmUoXCJpZFwiLCBpZF9zb2FsKS5vcmRlckJ5KFwiaWRcIiwgXCJhc2NcIik7XG4gICAgY29uc3Qga29tZW50YXJfc29hbCA9IGF3YWl0IEtvbWVudGFyX3NvYWwucXVlcnkoKVxuICAgICAgLndoZXJlKFwiaWRfc29hbFwiLCBpZF9zb2FsKVxuICAgICAgLm9yZGVyQnkoXCJpZFwiLCBcImFzY1wiKTtcblxuICAgIHJldHVybiB2aWV3LnJlbmRlcihcImF1dGgvbGloYXRzb2FsXCIsIHsgc29hbCwga29tZW50YXJfc29hbCB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBrb21lbnRhcih7IHJlc3BvbnNlLCByZXF1ZXN0IH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBsZXQgaWRfc29hbCA9IHJlcXVlc3QuaW5wdXQoXCJzb2Fsc19pZFwiKTtcbiAgICBjb25zdCBuYW1hID0gcmVxdWVzdC5pbnB1dChcIm5hbWFcIik7XG4gICAgY29uc3QgaXNpX2tvbWVudGFyID0gcmVxdWVzdC5pbnB1dChcImlzaV9rb21lbnRhclwiKTtcbiAgICBjb25zdCBoYXB1cyA9IHJlcXVlc3QuaW5wdXQoXCJoYXB1c1wiKTtcbiAgICBjb25zdCBpZCA9IHJlcXVlc3QuaW5wdXQoXCJrb21lbnRhcl9pZFwiKTtcblxuICAgIGlmIChoYXB1cyA9PSBcIjFcIikge1xuICAgICAgYXdhaXQgS29tZW50YXJfc29hbC5xdWVyeSgpLndoZXJlKFwiaWRcIiwgaWQpLmRlbGV0ZSgpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL2xpaGF0c29hbD9zb2Fsc19pZD1cIiArIGlkX3NvYWwpO1xuICAgIH1cblxuICAgIGlmICghbmFtYSkge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL2xpaGF0c29hbD9zb2Fsc19pZD1cIiArIGlkX3NvYWwpO1xuICAgIH1cbiAgICBpZiAoIWlzaV9rb21lbnRhcikge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL2xpaGF0c29hbD9zb2Fsc19pZD1cIiArIGlkX3NvYWwpO1xuICAgIH1cbiAgICBhd2FpdCBLb21lbnRhcl9zb2FsLmNyZWF0ZSh7IGlkX3NvYWwsIG5hbWFfa29tZW50YXI6IG5hbWEsIGlzaV9rb21lbnRhciB9KTtcblxuICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdChcIi9saWhhdHNvYWw/c29hbHNfaWQ9XCIgKyBpZF9zb2FsKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBlZGl0bWF0YWt1bGlhaCh7IHJlc3BvbnNlLCByZXF1ZXN0LCBzZXNzaW9uIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBzZW1lc3RlciA9IHJlcXVlc3QuaW5wdXQoXCJzZW1lc3RlclwiKTtcbiAgICBsZXQgY2FuY2VsID0gcmVxdWVzdC5pbnB1dChcImNhbmNlbFwiKTtcbiAgICBpZiAoc2Vzc2lvbi5nZXQoXCJlZGl0XCIpID09IDEpIHtcbiAgICAgIFxuICAgICAgaWYgKGNhbmNlbCA9PSBcIjJcIikge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3QoXCIvc2VtZXN0ZXI/c2VtZXN0ZXI9XCIgKyBzZW1lc3Rlcik7XG4gICAgICB9ZWxzZXtcbiAgICAgICAgY29uc3Qga29kZV9tayA9IHJlcXVlc3QuaW5wdXQoXCJrb2RlXCIpO1xuICAgICAgICBjb25zdCBuYW1hX21rID0gcmVxdWVzdC5pbnB1dChcIm5hbWFcIik7XG4gICAgICAgIGNvbnN0IHNrcyA9IHJlcXVlc3QuaW5wdXQoXCJza3NcIik7XG4gICAgICAgIGlmICgha29kZV9taykge1xuICAgICAgICAgIHNlc3Npb24uZmxhc2goJ2Vycm9yJywgJ0Vycm9yISBLb2RlTWF0YSBLdWxpYWggdGlkYWsgYm9sZWgga29zb25nIScpXG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3NlbWVzdGVyP3NlbWVzdGVyPVwiICsgc2VtZXN0ZXIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghbmFtYV9taykge1xuICAgICAgICAgIHNlc3Npb24uZmxhc2goJ2Vycm9yJywgJ0Vycm9yISBOYW1hIE1hdGEgS3VsaWFoIHRpZGFrIGJvbGVoIGtvc29uZyEnKVxuICAgICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdChcIi9zZW1lc3Rlcj9zZW1lc3Rlcj1cIiArIHNlbWVzdGVyKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXNrcykge1xuICAgICAgICAgIHNlc3Npb24uZmxhc2goJ2Vycm9yJywgJ0Vycm9yISBTS1MgdGlkYWsgYm9sZWgga29zb25nIScpXG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3NlbWVzdGVyP3NlbWVzdGVyPVwiICsgc2VtZXN0ZXIpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IE1hdGFrdWxpYWguY3JlYXRlKHsgaWRfc2VtZXN0ZXI6IHNlbWVzdGVyLCBrb2RlOiBrb2RlX21rLCBuYW1hOiBuYW1hX21rLCBza3M6IHNrc30pO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3QoXCIvc2VtZXN0ZXI/c2VtZXN0ZXI9XCIgKyBzZW1lc3Rlcik7XG4gICAgICB9XG4gICAgfWVsc2UgaWYgKHNlc3Npb24uZ2V0KFwiZWRpdFwiKSA9PSAzKSB7XG4gICAgICBpZiAoY2FuY2VsID09IFwiMlwiKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdChcIi9zZW1lc3Rlcj9zZW1lc3Rlcj1cIiArIHNlbWVzdGVyKTtcbiAgICAgIH1cbiAgICAgIGxldCBpZCA9IHJlcXVlc3QuaW5wdXQoXCJoYXB1c1wiKTtcbiAgICAgIGNvbnN0IHNvYWwgPSBhd2FpdCBTb2FsLnF1ZXJ5KCkud2hlcmUoXCJpZF9ta1wiLCBpZCkub3JkZXJCeShcImlkXCIsIFwiYXNjXCIpO1xuICAgICAgYXdhaXQgS29tZW50YXJfc29hbC5xdWVyeSgpLndoZXJlSW4oXCJpZF9zb2FsXCIsIHNvYWwubWFwKHJvdyA9PiByb3cuaWQudG9TdHJpbmcoKSkpLmRlbGV0ZSgpO1xuICAgICAgYXdhaXQgU29hbC5xdWVyeSgpLndoZXJlKFwiaWRfbWtcIiwgaWQpLmRlbGV0ZSgpO1xuICAgICAgYXdhaXQgTWF0YWt1bGlhaC5xdWVyeSgpLndoZXJlKFwiaWRcIiwgaWQpLmRlbGV0ZSgpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3NlbWVzdGVyP3NlbWVzdGVyPVwiICsgc2VtZXN0ZXIpO1xuXG4gICAgfWVsc2V7XG4gICAgICBzZXNzaW9uLnB1dChcIm1hdGFrdWxpYWhfaWRcIiwgcmVxdWVzdC5pbnB1dChcInVwZGF0ZVwiKSk7XG4gICAgICBpZiAoY2FuY2VsID09IFwiMlwiKSB7XG4gICAgICAgIHNlc3Npb24ucHV0KFwibWF0YWt1bGlhaF9pZFwiLCAtMSk7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdChcIi9zZW1lc3Rlcj9zZW1lc3Rlcj1cIiArIHNlbWVzdGVyKTtcbiAgICAgIH1lbHNlIGlmIChjYW5jZWwgPT0gXCIzXCIpIHtcbiAgICAgICAgbGV0IGlkID0gcmVxdWVzdC5pbnB1dChcInVwZGF0ZVwiKTtcbiAgICAgICAgY29uc3Qga29kZV9tayA9IHJlcXVlc3QuaW5wdXQoXCJrb2RlXCIpO1xuICAgICAgICBjb25zdCBuYW1hX21rID0gcmVxdWVzdC5pbnB1dChcIm5hbWFcIik7XG4gICAgICAgIGNvbnN0IHNrcyA9IHJlcXVlc3QuaW5wdXQoXCJza3NcIik7XG4gICAgICAgIGlmICgha29kZV9taykge1xuICAgICAgICAgIHNlc3Npb24uZmxhc2goJ2Vycm9yJywgJ0Vycm9yISBLb2RlIE1hdGEgS3VsaWFoIHRpZGFrIGJvbGVoIGtvc29uZyEnKVxuICAgICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdChcIi9zZW1lc3Rlcj9zZW1lc3Rlcj1cIiArIHNlbWVzdGVyKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIW5hbWFfbWspIHtcbiAgICAgICAgICBzZXNzaW9uLmZsYXNoKCdlcnJvcicsICdFcnJvciEgTmFtYSBNYXRhIEt1bGlhaCB0aWRhayBib2xlaCBrb3NvbmchJylcbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3QoXCIvc2VtZXN0ZXI/c2VtZXN0ZXI9XCIgKyBzZW1lc3Rlcik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFza3MpIHtcbiAgICAgICAgICBzZXNzaW9uLmZsYXNoKCdlcnJvcicsICdFcnJvciEgU0tTIHRpZGFrIGJvbGVoIGtvc29uZyEnKVxuICAgICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdChcIi9zZW1lc3Rlcj9zZW1lc3Rlcj1cIiArIHNlbWVzdGVyKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBNYXRha3VsaWFoLnF1ZXJ5KCkud2hlcmUoXCJpZFwiLCBpZCkudXBkYXRlKHtpZF9zZW1lc3Rlcjogc2VtZXN0ZXIsIGtvZGU6IGtvZGVfbWssIG5hbWE6IG5hbWFfbWssIHNrczogc2tzfSk7XG4gICAgICAgIHNlc3Npb24ucHV0KFwibWF0YWt1bGlhaF9pZFwiLCAtMSk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwia29kZV9ta1wiKTtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3NlbWVzdGVyP3NlbWVzdGVyPVwiICsgc2VtZXN0ZXIpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3NlbWVzdGVyP3NlbWVzdGVyPVwiICsgc2VtZXN0ZXIgKyBcIiZlZGl0PTJcIik7XG4gICAgfVxuICAgIFxuICB9XG5cbiAgcHVibGljIGFzeW5jIGVkaXRzb2FsKHsgcmVzcG9uc2UsIHJlcXVlc3QsIHNlc3Npb24gfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IGlkX21hdGFrdWxpYWggPSByZXF1ZXN0LmlucHV0KFwibWF0YWt1bGlhaF9pZFwiKTtcbiAgICBsZXQgY2FuY2VsID0gcmVxdWVzdC5pbnB1dChcImNhbmNlbFwiKTtcbiAgICBpZiAoc2Vzc2lvbi5nZXQoXCJlZGl0XCIpID09IDMpIHtcbiAgICAgIGlmIChjYW5jZWwgPT0gXCIyXCIpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KFwiL3NvYWw/bWF0YWt1bGlhaF9pZD1cIiArIGlkX21hdGFrdWxpYWgpO1xuICAgICAgfVxuICAgICAgbGV0IGlkID0gcmVxdWVzdC5pbnB1dChcImhhcHVzXCIpO1xuICAgICAgY29uc29sZS5sb2coaWQpO1xuICAgICAgYXdhaXQgS29tZW50YXJfc29hbC5xdWVyeSgpLndoZXJlKFwiaWRfc29hbFwiLCBpZCkuZGVsZXRlKCk7XG4gICAgICBhd2FpdCBTb2FsLnF1ZXJ5KCkud2hlcmUoXCJpZFwiLCBpZCkuZGVsZXRlKCk7XG4gICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3QoXCIvc29hbD9tYXRha3VsaWFoX2lkPVwiICsgaWRfbWF0YWt1bGlhaCk7XG5cbiAgICB9XG4gICAgXG4gIH1cbn1cbiJdfQ==